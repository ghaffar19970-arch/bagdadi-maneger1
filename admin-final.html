<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ â€” Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</title>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- html2canvas Ù„Ù„ØµÙˆØ±Ø© -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;800&display=swap');
  :root{
    --orange:#f97316; --orange-50:#fff7ed; --orange-600:#ea580c;
    --dark:#0f172a; --muted:#64748b;
    --green:#16a34a; --yellow:#f59e0b; --red:#dc2626; --violet:#8b5cf6; --blue:#3b82f6;
    --card:#ffffff; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow-x:hidden;font-family:'Cairo',sans-serif;background:var(--orange-50);color:#111827}
  /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) */
  #loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#fb923c,#f97316,#ea580c)}
  .login-card{width:100%;max-width:420px;background:#fff;border-radius:18px;padding:24px;box-shadow:0 18px 46px rgba(0,0,0,.18);text-align:center}
  .logo-box{background:linear-gradient(135deg,#fb923c,#f97316);color:#fff;border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,.18)}
  .logo-icon{background:#fff;color:#ea580c;display:inline-grid;place-items:center;width:54px;height:54px;border-radius:50%;font-size:26px;margin-bottom:8px}
  .logo-box h1{margin:0;font-size:24px;font-weight:800}
  .logo-box p{margin:0;opacity:.95}
  .login-card h2{margin:8px 0 14px}
  .inp{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:15px;margin:7px 0}
  .inp:focus{outline:none;border-color:var(--orange);box-shadow:0 0 0 3px rgba(249,115,22,.18)}
  .btn{width:100%;padding:12px;border:0;border-radius:12px;background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;font-weight:800;cursor:pointer}
  .small{font-size:12px;color:#6b7280;margin-top:10px}
  .msg{margin-top:8px} .ok{color:var(--green)} .err{color:var(--red)}

  /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
  #app{display:none;min-height:100vh}
  header{position:sticky;top:0;z-index:6;background:#fff;border-bottom:1px solid var(--border);
    padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .badge{display:inline-block;border:3px solid var(--orange);color:var(--orange);
    border-radius:12px;padding:10px 14px;font-weight:800;background:#fff}
  .who{background:#fff;border:1px solid #ffd8b6;border-radius:999px;padding:6px 10px;font-size:13px}
  .menu-btn{background:#fff;border:1px solid #ffe0c2;color:var(--orange);border-radius:10px;padding:8px 12px;cursor:pointer}

  /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ */
  .sidebar{position:fixed;inset:0 0 0 auto;width:0;max-width:300px;background:#0d0f12;color:#fff;transition:width .25s;overflow:hidden;z-index:20}
  .sidebar.open{width:88%}
  .sidebar-header{padding:18px;border-bottom:1px solid #1e293b}
  .sidebar-user{margin-top:8px;font-size:13px;opacity:.85}
  .nav a{display:block;color:#fff;text-decoration:none;padding:12px 18px;border-bottom:1px solid #111827}
  .nav a:hover{background:#111827}
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:15}
  .overlay.show{display:block}

  /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
  .content{padding:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px}
  .tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px}
  .tab{white-space:nowrap;border:1px solid var(--border);border-radius:999px;padding:8px 12px;cursor:pointer;background:#fff}
  .tab.active{background:var(--orange);color:#fff;border-color:transparent}
  .pill-count{background:rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;margin-inline-start:6px}
  .orders{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .order-card{border-radius:12px;padding:12px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
  .order-card p{margin:4px 0}
  .actions .btnx{border:0;border-radius:10px;padding:8px 10px;margin:4px 3px;cursor:pointer}
  .btnx-green{background:var(--green);color:#fff}
  .btnx-yellow{background:var(--yellow);color:#111}
  .btnx-red{background:var(--red);color:#fff}
  .btnx-gray{background:#334155;color:#fff}
  .pending{background:var(--blue)}
  .temp{background:#facc15;color:#111}
  .delayed{background:var(--violet)}
  .rejected{background:var(--red)}
  .delivered{background:#22c55e}

  /* Ø§Ù„Ø¨Ø­Ø« */
  .search-bar{display:flex;gap:8px}
  .search-bar input{flex:1}

  /* Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø±Ù…Ø§Ø¯ÙŠ */
  .arch-card{background:#eee;color:#111;border:1px solid #ddd}

  /* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© (Ù…Ø®ÙÙŠ â€” ÙŠÙØ¨Ù†Ù‰ Ø¯Ø§Ø®Ù„ JS) */
  #accReportWrapper{display:none}
  #accReport{
    background:#fff; padding:20px; margin:0 auto; border-radius:12px;
    width:900px; box-shadow:0 4px 12px rgba(0,0,0,.2); font-family:"Tahoma",sans-serif;
  }
  #accReport h2{ margin:0 0 20px; color:#f97316; text-align:center }
  .top-boxes{display:flex; justify-content:space-between; gap:10px; margin-bottom:20px; }
  .box-group{display:flex; gap:10px; flex:1}
  .box{flex:1; background:#f97316; color:#fff; padding:10px; border-radius:8px; font-size:14px; font-weight:bold; text-align:center}
  #accReport table{width:100%; border-collapse:collapse; font-size:14px; margin-top:15px}
  #accReport th, #accReport td{ border:1px solid #ccc; padding:8px; text-align:center }
  #accReport th{ background:#f97316; color:#fff }
  #accReport .footer{margin-top:15px; text-align:right; font-size:14px; font-weight:bold}
  audio{display:none}

  /* small helpers */
  .muted{color:var(--muted)}
  .link-like{color:#0ea5e9; text-decoration:underline; cursor:pointer}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<section id="loginScreen">
  <div class="login-card">
    <div class="logo-box">
      <div class="logo-icon">ğŸšš</div>
      <h1>Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ</h1>
      <p>Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</p>
    </div>
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input id="loginUser" class="inp" placeholder="user (Ù…Ø«Ø§Ù„: ibrahim)">
    <input id="loginPass" class="inp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="doLogin" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMsg" class="msg"></div>
    <div class="small">Â© 2025 Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
  </div>
</section>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<section id="app">
  <header>
    <button id="openMenu" class="menu-btn">â˜°</button>
    <div class="brand"><span class="badge">Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ â€” Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</span></div>
    <div id="whoami" class="who"></div>
  </header>

  <!-- Ù‚Ø§Ø¦Ù…Ø© ÙŠÙ…ÙŠÙ† -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <span class="badge">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
      <div id="sidebarUser" class="sidebar-user"></div>
    </div>
    <nav class="nav">
      <a href="#" data-page="home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="#" data-page="mandoubs">ğŸ‘¥ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ†</a>
      <a href="#" data-page="search">ğŸ” Ø§Ù„Ø¨Ø­Ø«</a>
      <a href="#" data-page="archive">ğŸ“¦ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</a>
      <a href="#" data-page="notifications">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>
      <a href="#" data-page="addOrder">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</a>
      <a href="#" data-page="addMandoub">ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨</a>
      <a href="#" data-page="people">ğŸ—‚ï¸ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ†</a>
      <!-- new: about -->
      <a href="#" data-page="about">â„¹ï¸ Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</a>
      <a href="#" id="logoutBtn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </nav>
  </aside>
  <div id="overlay" class="overlay"></div>

  <main class="content" id="content"></main>
</section>

<!-- Ø¹Ù†ØµØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ù…Ø®ÙÙŠ) Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© -->
<div id="accReportWrapper">
  <div id="accReport">
    <h2>ğŸšš Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h2>
    <div class="top-boxes">
      <div class="box-group">
        <div class="box" id="bxTotal">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ: 0</div>
        <div class="box" id="bxFees">Ø§Ù„Ø£Ø¬ÙˆØ±: 0</div>
        <div class="box" id="bxNet">Ø§Ù„ØµØ§ÙÙŠ: 0</div>
      </div>
      <div class="box-group">
        <div class="box" id="bxOp">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: -</div>
        <div class="box" id="bxDate">Ø§Ù„ØªØ§Ø±ÙŠØ®: -</div>
        <div class="box" id="bxCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: 0</div>
      </div>
    </div>
    <table id="accTable">
      <thead>
        <tr>
          <th>ØªØ³Ù„Ø³Ù„</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
          <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
          <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ</th>
        </tr>
      </thead>
      <tbody id="accBody"></tbody>
    </table>
    <div class="footer" id="accFooter">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: - â€” Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: -</div>
  </div>
</div>

<!-- ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ -->
<audio id="beep" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAACAA"></audio>

<!-- Firebase -->
<script type="module">
/* ========== Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc,
  onSnapshot, serverTimestamp, orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDmTFz_jU3HF8Jgb5wbpx_xtGvjBTPksOY",
  authDomain: "bagdadi-delivery.firebaseapp.com",
  projectId: "bagdadi-delivery",
  storageBucket: "bagdadi-delivery.appspot.com",
  messagingSenderId: "957413017368",
  appId: "1:957413017368:web:a9c7373f0cf3e95cbc806d"
};
const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

/* ========== Helpers ========== */
const $ = s => document.querySelector(s);
const content = $('#content'); const overlay = $('#overlay'); const sidebar = $('#sidebar'); const beep=$('#beep');
const fmtN = n => Number(n||0).toLocaleString('en-US');
const apm = d => {let h=d.getHours(),m=(''+d.getMinutes()).padStart(2,'0'),ap=h>=12?'Ù…':'Øµ';h=h%12||12;return `${h}:${m} ${ap}`;}
function showMsg(id,msg,type){ const el = $('#'+id); el.className='msg '+type; el.textContent=msg; }
function statusText(s){ return s==='pending'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': s==='temp'?'Ù…Ø¤Ù‚Øª': s==='delayed'?'Ù…Ø¤Ø¬Ù„': s==='delivered'?'ÙˆØ§ØµÙ„':'Ù…Ø±ÙÙˆØ¶'; }
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
function randOp(){ return Math.floor(100000+Math.random()*900000).toString(); }

/* ========== Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© ========== */
$('#openMenu').onclick=()=>{sidebar.classList.add('open');overlay.classList.add('show');};
overlay.onclick=()=>{sidebar.classList.remove('open');overlay.classList.remove('show');};
sidebar.querySelectorAll('a[data-page]').forEach(a=>{
  a.onclick=(e)=>{e.preventDefault();sidebar.classList.remove('open');overlay.classList.remove('show');showPage(a.dataset.page);}
});

/* ========== Ø¬Ù„Ø³Ø© Ø¯Ø®ÙˆÙ„ ========== */
function getSession(){ try { return JSON.parse(localStorage.getItem('session')||'null'); } catch { return null; } }
function saveSession(obj){ try{ localStorage.setItem('session', JSON.stringify(obj)); }catch{} }
function requireLogin(){
  const ses=getSession();
  if(!ses){ $('#loginScreen').style.display='flex'; $('#app').style.display='none'; }
  else{ $('#loginScreen').style.display='none'; $('#app').style.display='block';
    $('#whoami').textContent = `${ses.name||ses.user} â€¢ ${ses.role||''}`;
    $('#sidebarUser').textContent = `${ses.name||ses.user} â€” ${ses.role||''}`;
    // Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†
    showPage('home');
    // Ø´ØºÙ‘Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ÙŠÙ‚Ø§Ù)
    startStatusWatcher();
  }
}
$('#doLogin').onclick = async ()=>{
  const u=$('#loginUser').value.trim().toLowerCase(), p=$('#loginPass').value.trim();
  if(!u||!p) return showMsg('loginMsg','âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','err');
  showMsg('loginMsg','Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚â€¦','ok');
  try{
    const qUser=query(collection(db,'users'), where('user','==',u), where('password','==',p));
    const snap=await getDocs(qUser);
    if(snap.empty) return showMsg('loginMsg','âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©','err');
    const d=snap.docs[0].data();
    if(d.status === 'inactive'){
      return showMsg('loginMsg','ğŸš« ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©','err');
    }
    const sess = { id:snap.docs[0].id, user:d.user, name:d.name||'', role:d.role||'', status:d.status||'active' };
    saveSession(sess);
    Swal.fire({icon:'success',title:`Ø£Ù‡Ù„Ù‹Ø§ ${d.name||d.user}`,timer:900,showConfirmButton:false});
    requireLogin();
  }catch(e){ showMsg('loginMsg','Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: '+e.message,'err'); }
};
$('#logoutBtn').onclick=(e)=>{
  e.preventDefault();
  Swal.fire({title:'ØªØ£ÙƒÙŠØ¯',text:'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',icon:'warning',showCancelButton:true,confirmButtonText:'Ù†Ø¹Ù…',cancelButtonText:'Ù„Ø§'})
  .then(r=>{ if(r.isConfirmed){ localStorage.removeItem('session'); requireLogin(); }});
};

/* ========== status watcher (every 60s) ========== */
let statusWatcher = null;
function startStatusWatcher(){
  if(statusWatcher) clearInterval(statusWatcher);
  const ses = getSession();
  if(!ses) return;
  // also run immediate check
  (async ()=>{
    try{
      const ref = doc(db,'users', ses.id);
      const dd  = await getDoc(ref);
      if(dd.exists() && dd.data().status === 'inactive'){
        localStorage.removeItem('session');
        Swal.fire('ğŸš« ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©','warning').then(()=> location.reload());
      }
    }catch{}
  })();
  statusWatcher = setInterval(async ()=>{
    try{
      const ref = doc(db,'users', ses.id);
      const dd  = await getDoc(ref);
      if(dd.exists() && dd.data().status === 'inactive'){
        localStorage.removeItem('session');
        Swal.fire('ğŸš« ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©','warning').then(()=> location.reload());
      }
    }catch{}
  }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
}

/* ========== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª ========== */
async function showPage(p){
  if(p==='home') return renderHome();
  if(p==='mandoubs') return renderMandoubs();
  if(p==='search') return renderSearch();
  if(p==='archive') return renderArchive();
  if(p==='notifications') return renderNotifications();
  if(p==='addOrder') return renderAddOrder();
  if(p==='addMandoub') return renderAddMandoub();
  if(p==='people') return renderPeople();
  if(p==='about') return renderAbout();
}

/* ========== Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¨Ø·Ø§Ù‚Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨) ========== */
async function renderHome(){
  // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
  const mSnap = await getDocs(collection(db,'mandoubs'));
  const mandoubs = [];
  mSnap.forEach(d=> mandoubs.push({ id:d.id, ...(d.data()) }));

  // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· (Ù…Ùˆ Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
  const oSnap = await getDocs(collection(db,'orders'));
  const countsByMand = {}; // mandoubId -> {pending, delayed, delivered, rejected}
  oSnap.forEach(d=>{
    const o = d.data();
    const mid = o.mandoubId;
    if(!mid) return;
    if(!countsByMand[mid]) countsByMand[mid] = { pending:0, delayed:0, delivered:0, rejected:0 };
    const s = o.status || 'pending';
    if(s==='pending') countsByMand[mid].pending++;
    else if(s==='delayed') countsByMand[mid].delayed++;
    else if(s==='delivered') countsByMand[mid].delivered++;
    else if(s==='rejected') countsByMand[mid].rejected++;
  });

  // Ù†Ø¨Ù†ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ø¨Ø·Ø§Ù‚Ø© Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  let html = `<div class="card"><h3>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€” Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨</h3><div class="muted">ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… â€¢ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹ + Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>`;
  html += `<div class="orders">`;

  mandoubs.forEach(m=>{
    const c = countsByMand[m.id] || { pending:0, delayed:0, delivered:0, rejected:0 };
    const total = c.pending + c.delayed + c.delivered + c.rejected;
    html += `
      <div class="card" style="border-color:#ffd8b6;background:#fff;color:#111">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div style="font-weight:800">ğŸï¸ ${m.name||'-'}</div>
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${fmtN(total)}</b></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px">
          <div style="background:#ede9fe;color:#4c1d95;border:1px solid #c4b5fd;border-radius:10px;padding:10px;text-align:center;font-weight:800">
            Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°<br><span style="font-size:20px">${fmtN(c.pending)}</span>
          </div>
          <div style="background:#fef9c3;color:#854d0e;border:1px solid #fde68a;border-radius:10px;padding:10px;text-align:center;font-weight:800">
            Ù…Ø¤Ø¬Ù„<br><span style="font-size:20px">${fmtN(c.delayed)}</span>
          </div>
          <div style="background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;border-radius:10px;padding:10px;text-align:center;font-weight:800">
            ÙˆØ§ØµÙ„<br><span style="font-size:20px">${fmtN(c.delivered)}</span>
          </div>
          <div style="background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:10px;text-align:center;font-weight:800">
            Ø±ÙØ¶<br><span style="font-size:20px">${fmtN(c.rejected)}</span>
          </div>
        </div>
      </div>`;
  });

  if(mandoubs.length===0){
    html += `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§</div>`;
  }
  html += `</div>`;

  content.innerHTML = html;
}

/* ========== Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========== */
async function renderAbout(){
  content.innerHTML = `
    <div class="card" style="border-color:#ffd8b6">
      <h2 style="margin:6px 0;color:#ea580c">Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ Ù„Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h2>
      <p><b>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> Ø§Ù„Ø¹Ø±Ø§Ù‚ â€“ Ø§Ù„Ø£Ù†Ø¨Ø§Ø± â€“ Ù‚Ø¶Ø§Ø¡ Ù‡ÙŠØª â€“ Ù†Ø§Ø­ÙŠØ© Ø§Ù„Ø¨ØºØ¯Ø§Ø¯ÙŠ â€“ Ø§Ù„Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¹Ø§Ù…</p>
      <p><b>ğŸ¢ Ù…Ù† Ù†Ø­Ù†:</b> Ø´Ø±ÙƒØ© Ù…Ø®ØªØµÙ‘Ø© Ø¨Ù†Ù‚Ù„ Ø¨Ø¶Ø§Ø¦Ø¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØªÙˆØµÙŠÙ„Ù‡Ø§ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø±. ØªØ£Ø³Ø³Øª Ø¹Ø§Ù… 2020 ÙˆÙ†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± 24 Ø³Ø§Ø¹Ø©.</p>
      <p><b>â˜ï¸ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</b> <a href="tel:07810433473">07810433473</a> â€” <a href="tel:07823789656">07823789656</a></p>
      <p><b>ğŸ‘¨â€ğŸ’» Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±:</b> ØªÙ… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <b>Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ ØºÙÙˆØ±ÙŠ</b> â€” <a href="tel:07810433473">07810433473</a></p>
    </div>
  `;
}

/* ========== Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ† + ØµÙØ­Ø© ÙƒÙ„ Ù…Ù†Ø¯ÙˆØ¨ (Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ØµÙˆØ±Ø©) ========== */
async function renderMandoubs(){
  const snap = await getDocs(collection(db,'mandoubs'));
  let html = `<div class="card"><h3>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ†</h3></div><div class="orders">`;
  snap.forEach(d=>{
    const m=d.data();
    html += `<div class="order-card" style="background:#fff;color:#111;border:1px solid var(--border)">
      <p class="mname" data-id="${d.id}" data-name="${m.name}" style="font-weight:800;cursor:pointer">ğŸï¸ ${m.name}</p>
      <small>Ù‡Ø§ØªÙ: ${m.phone||'-'} â€” ÙŠÙˆØ²Ø±: ${m.user||'-'}</small>
    </div>`;
  });
  html += `</div>`;
  content.innerHTML = html;

  document.querySelectorAll('.mname').forEach(el=>{
    el.onclick = ()=> renderMandoubPage(el.dataset.id, el.dataset.name);
  });
}

async function renderMandoubPage(mandoubId, mandoubName){
  content.innerHTML = `
    <div class="card" id="mHead">
      <h3 style="margin:8px 0">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${mandoubName}</h3>
      <div id="finLine" class="small">â€¦</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="btn" id="btnAccountingImg" style="flex:1;background:#4f46e5">ğŸ“„ Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (ØµÙˆØ±Ø©)</button>
        <button class="btn" id="btnArchive" style="flex:1;background:#16a34a">ğŸ“¦ ØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
        <button class="btn" id="btnReset" style="flex:1;background:#dc2626">â™»ï¸ ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ</button>
      </div>
    </div>
    <div class="card">
      <div class="tabs" id="orderTabs">
        <div class="tab active" data-k="pending">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° <span class="pill-count" id="mc-pending">0</span></div>
        <div class="tab" data-k="temp">Ù…Ø¤Ù‚Øª Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± <span class="pill-count" id="mc-temp">0</span></div>
        <div class="tab" data-k="delayed">Ø§Ù„Ù…Ø¤Ø¬Ù„ <span class="pill-count" id="mc-delayed">0</span></div>
        <div class="tab" data-k="delivered">Ø§Ù„ÙˆØ§ØµÙ„ <span class="pill-count" id="mc-delivered">0</span></div>
        <div class="tab" data-k="rejected">Ø§Ù„Ø±ÙØ¶ <span class="pill-count" id="mc-rejected">0</span></div>
      </div>
      <div id="ordersWrap"></div>
    </div>
  `;

  const mRef = doc(db,'mandoubs',mandoubId);
  const mDoc = await getDoc(mRef);
  let lastAccountingAt = mDoc.data()?.lastAccountingAt?.toDate?.() || null;
  let lastResetAt = mDoc.data()?.lastResetAt?.toDate?.() || null;

  const q1 = query(collection(db,'orders'), where('mandoubId','==', mandoubId));
  onSnapshot(q1, (snap)=>{
    let lists = { pending:[], temp:[], delayed:[], delivered:[], rejected:[] };
    let total=0;
    snap.forEach(d=>{
      const o=d.data(); o._id=d.id; (lists[o.status||'pending']).push(o);
      if(o.status==='delivered') total += Number(o.amount||0);
    });
    const fees = (lists.delivered.length)*1000, net= total - fees;
    $('#finLine').innerHTML = `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ: <b>${fmtN(total)}</b> â€¢ Ø§Ù„Ø£Ø¬ÙˆØ±: <b>${fmtN(fees)}</b> â€¢ Ø§Ù„ØµØ§ÙÙŠ: <b>${fmtN(net)}</b>
      ${lastAccountingAt?` â€¢ Ø¢Ø®Ø± Ù…Ø­Ø§Ø³Ø¨Ø©: ${lastAccountingAt.toLocaleDateString()} ${apm(lastAccountingAt)}`:''}
      ${lastResetAt?` â€¢ Ø¢Ø®Ø± ØªØµÙÙŠØ±: ${lastResetAt.toLocaleDateString()} ${apm(lastResetAt)}`:''}`;

    ['pending','temp','delayed','delivered','rejected'].forEach(k=>$('#mc-'+k).textContent = (lists[k]||[]).length);

    function draw(kind){
      const arr = lists[kind]||[]; let html='';
      if(!arr.length){ html = `<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`; }
      else{
        html = `<div class="orders">` + arr.map(o=>{
          const cls = kind==='pending'?'pending':kind==='temp'?'temp':kind==='delayed'?'delayed':kind==='delivered'?'delivered':'rejected';
          return `<div class="order-card ${cls}">
            <p>ğŸ“¦ <b>ÙˆØµÙ„:</b> ${o.wasl||'-'}</p>
            <p>ğŸ“± <span class="cust-phone" data-phone="${o.phone||''}" style="text-decoration:underline;cursor:pointer">${o.phone||'-'}</span> â€¢ ğŸ™ï¸ ${o.gov||'-'} â€” ${o.area||'-'}</p>
            <p>ğŸ’µ ${fmtN(o.amount)} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: <b>${statusText(o.status)}</b></p>
            ${o.managerNote? `<p>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ${o.managerNote}</p>`:''}
            ${o.reason? `<p>ğŸ“Œ Ø³Ø¨Ø¨: ${o.reason}${o.newAmount?` â€” Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯: ${fmtN(o.newAmount)}`:''}</p>`:''}
            <div class="actions">
              ${kind==='pending' ? `
                <button class="btnx btnx-green" onclick="setDelivered('${o._id}')">âœ… ÙˆØ§ØµÙ„</button>
                <button class="btnx btnx-yellow" onclick="delayDirect('${o._id}')">â³ Ù…Ø¤Ø¬Ù„</button>
                <button class="btnx btnx-red" onclick="askReject('${o._id}')">âŒ Ø±ÙØ¶</button>
                <button class="btnx btnx-gray" onclick="askNote('${o._id}')">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                <button class="btnx btnx-red" onclick="askDelete('${o._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              ` : kind==='delivered' ? `
                <button class="btnx btnx-gray" onclick="backToPending('${o._id}')">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ù‚ÙŠØ¯</button>
                <button class="btnx btnx-red" onclick="askDelete('${o._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              ` : kind==='delayed' ? `
                <button class="btnx btnx-green" onclick="setDelivered('${o._id}')">âœ… ÙˆØ§ØµÙ„</button>
                <button class="btnx btnx-red" onclick="askReject('${o._id}')">âŒ Ø±ÙØ¶</button>
                <button class="btnx btnx-gray" onclick="backToPending('${o._id}')">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ù‚ÙŠØ¯</button>
                <button class="btnx btnx-red" onclick="askDelete('${o._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              ` : kind==='rejected' ? `
                <button class="btnx btnx-green" onclick="setDelivered('${o._id}')">âœ… ÙˆØ§ØµÙ„</button>
                <button class="btnx btnx-yellow" onclick="delayDirect('${o._id}')">â³ Ù…Ø¤Ø¬Ù„</button>
                <button class="btnx btnx-gray" onclick="backToPending('${o._id}')">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ù‚ÙŠØ¯</button>
                <button class="btnx btnx-red" onclick="askDelete('${o._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              ` : /* temp */ `
                <button class="btnx btnx-green" onclick="approveTemp('${o._id}')">âœ… Ù…ÙˆØ§ÙÙ‚</button>
                <button class="btnx btnx-gray" onclick="backToPending('${o._id}')">â†©ï¸ ÙƒÙ„Ø§ (Ø¥Ø±Ø¬Ø§Ø¹ Ù‚ÙŠØ¯)</button>
                <button class="btnx btnx-yellow" onclick="askNote('${o._id}')">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©</button>
              `}
            </div>
          </div>`;
        }).join('') + `</div>`;
      }
      $('#ordersWrap').innerHTML = html;

      // Ø¨Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙØ¹Ù„ Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†
      document.querySelectorAll('.cust-phone[data-phone]').forEach(el=>{
        el.onclick = ()=>{
          const phone = (el.dataset.phone||'').trim(); if(!phone) return;
          const intl = `964${phone.replace(/^0/,'')}`;
          Swal.fire({
            title:`Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ: ${phone}`,
            html: `
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px">
                <a href="tel:${phone}" class="btnx btnx-green" style="text-decoration:none">ğŸ“ Ø§ØªØµØ§Ù„</a>
                <a href="sms:${phone}" class="btnx btnx-yellow" style="text-decoration:none">âœ‰ï¸ SMS</a>
                <a href="https://wa.me/${intl}" target="_blank" class="btnx" style="background:#25d366;color:#fff;text-decoration:none">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
                <button id="copyPhone" class="btnx btnx-red">ğŸ“‹ Ù†Ø³Ø®</button>
              </div>`,
            showConfirmButton:false, showCloseButton:true
          });
          setTimeout(()=>{
            const cp = document.getElementById('copyPhone');
            if(cp){ cp.onclick = ()=>{ navigator.clipboard.writeText(phone); Swal.fire('ØªÙ…','ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…','success'); }; }
          }, 50);
        };
      });
    }

    $('#orderTabs').querySelectorAll('.tab').forEach(t=>{
      t.onclick = ()=>{ $('#orderTabs').querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); draw(t.dataset.k); };
    });
    draw(document.querySelector('#orderTabs .tab.active').dataset.k);
  });

  // ======== Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ÙƒØµÙˆØ±Ø© (JPG) ========
  $('#btnAccountingImg').onclick = async ()=>{
    const ses=getSession(); const accountant = ses?.name || ses?.user || 'Ù…Ø¯ÙŠØ±';
    const q = query(collection(db,'orders'), where('mandoubId','==',mandoubId), where('status','==','delivered'));
    const s = await getDocs(q);

    const rows = []; let total=0;
    let i=1;
    s.forEach(d=>{
      const o=d.data();
      rows.push({
        idx:i++,
        wasl:(o.wasl||''),
        company:(o.company||''),
        gov:(o.gov||''),
        area:(o.area||''),
        amount:Number(o.amount||0)
      });
      total += Number(o.amount||0);
    });
    const fees = (rows.length)*1000;
    const net  = total - fees;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ÙÙŠ
    $('#bxTotal').textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ: ' + fmtN(total);
    $('#bxFees').textContent  = 'Ø§Ù„Ø£Ø¬ÙˆØ±: ' + fmtN(fees);
    $('#bxNet').textContent   = 'Ø§Ù„ØµØ§ÙÙŠ: ' + fmtN(net);
    $('#bxOp').textContent    = 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + randOp();
    $('#bxDate').textContent  = 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + todayISO();
    $('#bxCount').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ' + rows.length;

    const body = $('#accBody'); body.innerHTML='';
    if(rows.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ§ØµÙ„ â€” ØªÙ‚Ø±ÙŠØ± Ù‡ÙŠÙƒÙ„ÙŠ</td>`;
      body.appendChild(tr);
    }else{
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.idx}</td>
          <td>${r.wasl}</td>
          <td>${r.company}</td>
          <td>${r.gov}</td>
          <td>${r.area}</td>
          <td>${fmtN(r.amount)}</td>
          <td>${fmtN(r.amount - 1000)}</td>
        `;
        body.appendChild(tr);
      });
    }
    $('#accFooter').textContent = `Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${mandoubName} â€” Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: ${accountant}`;

    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© ÙˆÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
    const node = document.querySelector('#accReport');
    const canvas = await html2canvas(node, { scale: 2, backgroundColor:'#fff' });
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const win = window.open('');
    win.document.write('<title>ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø§Ø³Ø¨Ø© â€” ØµÙˆØ±Ø©</title>');
    win.document.write('<img src="'+imgData+'" style="width:100%;max-width:1000px;display:block;margin:auto;">');
    win.document.close();
    Swal.fire('ØªÙ…','ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© (ØµÙˆØ±Ø©)','success');
  };

  // ØªØ±Ø­ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø´Ø±Ø·: Ø¹Ø§Ù…Ù„ Ù…Ø­Ø§Ø³Ø¨Ø©)
  $('#btnArchive').onclick = async ()=>{
    const md = await getDoc(mRef);
    const lastAcc = md.data()?.lastAccountingAt;
    if(!lastAcc){ return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ù‚Ø¨Ù„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨','warning'); }
    const conf = await Swal.fire({title:'ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',text:'Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„ÙˆØ§ØµÙ„ (Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) ÙˆÙ†Ø³Ø® Ø§Ù„Ø±ÙØ¶ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',icon:'warning',showCancelButton:true,confirmButtonText:'ØªØ±Ø­ÙŠÙ„'});
    if(!conf.isConfirmed) return;

    // delivered â†’ archive (ÙˆÙ†Ø­Ø°ÙÙ‡Ù… Ù…Ù† orders)
    const qDel = query(collection(db,'orders'), where('mandoubId','==',mandoubId), where('status','==','delivered'));
    const sDel = await getDocs(qDel);
    for (const d of sDel.docs){
      const o=d.data();
      await addDoc(collection(db,'archive'),{
        ...o, archivedAt:serverTimestamp(), archivedBy:(getSession()?.name||getSession()?.user||'Ù…Ø¯ÙŠØ±'),
        mandoubId, mandoubName, archiveSource:'delivered', lastStatus:'delivered'
      });
      await deleteDoc(doc(db,'orders', d.id));
    }
    // rejected â†’ archive (Ù†Ø³Ø® ÙÙ‚Ø·)
    const qRej = query(collection(db,'orders'), where('mandoubId','==',mandoubId), where('status','==','rejected'));
    const sRej = await getDocs(qRej);
    for (const d of sRej.docs){
      const o=d.data();
      await addDoc(collection(db,'archive'),{
        ...o, archivedAt:serverTimestamp(), archivedBy:(getSession()?.name||getSession()?.user||'Ù…Ø¯ÙŠØ±'),
        mandoubId, mandoubName, archiveSource:'rejected', lastStatus:'rejected'
      });
    }

    // Ø¥Ø´Ø¹Ø§Ø±ÙŠÙ†
    await addDoc(collection(db,'notifications'),{
      to: mandoubId, roleTarget:'mandoub', title:'ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', message:`ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©`, at:serverTimestamp(), seen:false
    });
    await addDoc(collection(db,'notifications'),{
      to: 'managers', roleTarget:'manager', title:'ØªØ±Ø­ÙŠÙ„ Ù…ÙƒØªÙ…Ù„', message:`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${mandoubName}`, at:serverTimestamp(), seen:false
    });

    Swal.fire('ØªÙ…','Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ±Ø­ÙŠÙ„','success');
  };

  // ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ (ÙŠØ³Ø¬Ù„ ÙˆÙ‚Øª Ø§Ù„ØªØµÙÙŠØ± ÙÙ‚Ø·)
  $('#btnReset').onclick = async ()=>{
    const r = await Swal.fire({title:'ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ',text:'ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ',icon:'question',showCancelButton:true,confirmButtonText:'ØªØµÙÙŠØ±'});
    if(!r.isConfirmed) return;
    await updateDoc(mRef, { lastResetAt: serverTimestamp() });
    Swal.fire('ØªÙ…','ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ','success');
  };
}

/* ========== Ø§Ù„Ø¨Ø­Ø« ========== */
async function renderSearch(){
  content.innerHTML = `
    <div class="card">
      <h3>Ø§Ù„Ø¨Ø­Ø«</h3>
      <div class="search-bar">
        <input id="q" class="inp" style="height:56px;font-size:18px" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ÙˆØµÙ„ / Ù‡Ø§ØªÙ / Ø´Ø±ÙƒØ© / Ø§Ø³Ù… Ù…Ù†Ø¯ÙˆØ¨">
        <button class="btn" id="go" style="max-width:160px">Ø¨Ø­Ø«</button>
      </div>
      <div id="results" style="margin-top:10px"></div>
    </div>
  `;
  $('#go').onclick = async ()=>{
    const key=$('#q').value.trim(); if(!key) return;
    const all=[];
    const oSnap=await getDocs(collection(db,'orders'));
    const aSnap=await getDocs(collection(db,'archive'));
    oSnap.forEach(d=>all.push({...d.data(), _id:d.id, _where:'current'}));
    aSnap.forEach(d=>all.push({...d.data(), _id:d.id, _where:'archive'}));
    const k=key.toLowerCase();
    const res=all.filter(o=>
      String(o.wasl||'').includes(key) || String(o.phone||'').includes(key) ||
      String(o.company||'').toLowerCase().includes(k) || String(o.mandoubName||'').toLowerCase().includes(k)
    );
    if(!res.length) return $('#results').innerHTML=`<div class="card">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
    let html = `<div class="orders">`+res.map(o=>{
      const color=o._where==='archive'?'arch-card':(o.status==='pending'?'pending':o.status==='temp'?'temp':o.status==='delayed'?'delayed':o.status==='delivered'?'delivered':'rejected');
      return `<div class="order-card ${color}">
        <p>ğŸ“¦ <b>${o.wasl||'-'}</b> â€” ${o._where==='archive'?'Ø£Ø±Ø´ÙŠÙ':'Ø­Ø§Ù„ÙŠ'}</p>
        <p>ğŸ‘¤ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${o.mandoubName||'-'} â€” Ø§Ù„Ø´Ø±ÙƒØ©: ${o.company||'-'}</p>
        <p>ğŸ’µ ${fmtN(o.amount)} â€” Ø§Ù„Ø­Ø§Ù„Ø©: <b>${o._where==='archive'? (o.lastStatus||'-') : statusText(o.status)}</b></p>
      </div>`;
    }).join('')+`</div>`;
    $('#results').innerHTML=html;
  };
}

/* ========== Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø±Ù…Ø§Ø¯ÙŠ ÙˆØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ========== */
async function renderArchive(){
  const aSnap = await getDocs(collection(db,'archive'));
  if(aSnap.empty){ content.innerHTML = `<div class="card">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</div>`; return; }
  let html = `<div class="orders">`;
  aSnap.forEach(d=>{
    const o=d.data(); const dt=o.archivedAt?.toDate?.();
    html += `<div class="order-card arch-card">
      <p>ğŸ“¦ <b>Ø§Ù„ÙˆØµÙ„:</b> ${o.wasl||'-'} â€¢ <b>Ø§Ù„Ø´Ø±ÙƒØ©:</b> ${o.company||'-'}</p>
      <p>ğŸ‘¤ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${o.mandoubName||'-'} â€¢ ğŸ“± ${o.phone||'-'}</p>
      <p>ğŸ™ï¸ ${o.gov||'-'} â€” ${o.area||'-'} â€¢ ğŸ’µ ${fmtN(o.amount||0)}</p>
      <p>Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø±Ø´ÙØ©: <b>${o.lastStatus||'-'}</b> â€¢ Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©: ${o.managerNote||o.reason||'-'}</p>
      <small>Ø£ÙØ±Ø´Ù Ø¨ÙˆØ§Ø³Ø·Ø©: ${o.archivedBy||'-'} â€¢ ${dt?dt.toLocaleDateString()+' '+apm(dt):''}</small>
    </div>`;
  });
  html += `</div>`;
  content.innerHTML = html;
}

/* ========== Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ ========== */
async function renderAddMandoub(){
  content.innerHTML = `
    <div class="card">
      <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯</h3>
      <input id="mName" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
      <input id="mPhone" class="inp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
      <input id="mUser" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„)">
      <input id="mPass" class="inp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„ØªØ³Ø¬ÙŠÙ„)">
      <button class="btn" id="saveM">Ø­ÙØ¸</button>
    </div>
  `;
  $('#saveM').onclick = async ()=>{
    const name=$('#mName').value.trim(), phone=$('#mPhone').value.trim(),
          user=$('#mUser').value.trim().toLowerCase(), password=$('#mPass').value.trim();
    if(!name||!phone||!user||!password) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„','warning');
    await addDoc(collection(db,'mandoubs'),{name, phone, user, password, status:'active'});
    await addDoc(collection(db,'users'),{user,password,name,role:'Ù…Ù†Ø¯ÙˆØ¨',status:'active'});
    Swal.fire('ØªÙ…','Ø£ÙØ¶ÙŠÙ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„','success');
    renderMandoubs();
  };
}

/* ========== Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ========== */
async function renderAddOrder(){
  const ms=await getDocs(collection(db,'mandoubs'));
  let opts=''; ms.forEach(d=>{const m=d.data(); opts+=`<option value="${d.id}" data-name="${m.name}">${m.name}</option>`})
  content.innerHTML = `
    <div class="card">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</h3>
      <select id="oM" class="inp">${opts}</select>
      <input id="oWasl" class="inp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„">
      <input id="oAmount" type="number" class="inp" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
      <input id="oGov" class="inp" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
      <input id="oArea" class="inp" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
      <input id="oPhone" class="inp" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†">
      <input id="oCompany" class="inp" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
      <textarea id="oNotes" class="inp" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      <button class="btn" id="saveO">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  `;
  $('#saveO').onclick = async ()=>{
    const ses=getSession(); if(!ses) return;
    const wasl=$('#oWasl').value.trim(), amount=Number($('#oAmount').value||0),
      mandoubId=$('#oM').value, mandoubName=$('#oM').selectedOptions[0].dataset.name,
      gov=$('#oGov').value.trim(), area=$('#oArea').value.trim(),
      phone=$('#oPhone').value.trim(), company=$('#oCompany').value.trim(), notes=$('#oNotes').value.trim();
    if(!wasl||!amount||!mandoubId||!gov||!area||!phone||!company) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„','warning');

    const ref = await addDoc(collection(db,'orders'),{
      wasl, amount, mandoubId, mandoubName, gov, area, phone, company, notes:notes||'',
      status:'pending', createdAt: serverTimestamp(), lastUpdate: serverTimestamp()
    });
    await addDoc(collection(db,'notifications'),{
      to: mandoubId, roleTarget:'mandoub', type:'new_order', title:'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
      message:`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ #${wasl}`, orderId: ref.id, by:(ses.name||ses.user), at:serverTimestamp(), seen:false
    });
    await addDoc(collection(db,'notifications'),{
      to: 'managers', roleTarget:'manager', type:'new_order_copy', title:'Ù†Ø³Ø®Ø©: Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
      message:`(Ù†Ø³Ø®Ø©) Ø£ÙØ¶ÙŠÙ Ø·Ù„Ø¨ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ${mandoubName}`, orderId: ref.id, by:(ses.name||ses.user), at:serverTimestamp(), seen:false
    });
    Swal.fire('ØªÙ…','Ø£ÙØ¶ÙŠÙ Ø§Ù„Ø·Ù„Ø¨','success');
    ['oWasl','oAmount','oGov','oArea','oPhone','oCompany','oNotes'].forEach(id=>$('#'+id).value='');
  };
}

/* ========== Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ† (Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ø±Ø¶/Ø£Ø²Ø±Ø§Ø±) ========== */
async function renderPeople(){
  const ses = getSession();
  if(!ses) return requireLogin();

  // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const isExec = (ses.role === 'Ù…Ø¯ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ' || /ØªÙ†ÙÙŠØ°ÙŠ/i.test(ses.role||''));
  const isTech = (ses.role === 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙÙ†ÙŠ' || /ÙÙ†ÙŠ/i.test(ses.role||''));
  const isFollow = (ses.role === 'Ù…ÙˆØ¸Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©' || /Ù…ØªØ§Ø¨Ø¹Ø©/i.test(ses.role||''));

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const usSnap = await getDocs(collection(db,'users'));
  const mSnap  = await getDocs(collection(db,'mandoubs'));

  // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  let html = '';

  // ---------- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (users) ----------
  html += `<div class="card"><h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3></div>`;
  if(usSnap.empty){
    html += `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</div>`;
  } else {
    usSnap.forEach(d=>{
      const u = d.data();
      if(isExec){
        html += `<div class="order-card" style="background:#fff;color:#111;border:1px solid var(--border);">
          <p><b>${u.name||u.user}</b> â€” <small>${u.role||''}</small></p>
          <p>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: <b>${u.phone||'-'}</b></p>
          <p>ğŸ”‘ ÙŠÙˆØ²Ø±: <b>${u.user||'-'}</b> â€¢ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <b>${u.password||'-'}</b></p>
          <div style="margin-top:8px">
            <button class="btnx btnx-red" data-act="del" data-type="users" data-id="${d.id}">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            ${u.status==='inactive'
              ? `<button class="btnx btnx-green" data-act="activate" data-type="users" data-id="${d.id}">ğŸŸ¢ ØªÙØ¹ÙŠÙ„</button>`
              : `<button class="btnx btnx-yellow" data-act="deactivate" data-type="users" data-id="${d.id}">ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>`}
            <button class="btnx btnx-gray" data-act="resetpw" data-type="users" data-id="${d.id}">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
          </div>
        </div>`;
      } else if(isTech || isFollow){
        html += `<div class="order-card" style="background:#fff;color:#111;border:1px solid var(--border);">
          <p><b>${u.name||u.user}</b></p>
        </div>`;
      }
    });
  }

  // ---------- Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ† (mandoubs) ----------
  html += `<div style="height:8px"></div><div class="card"><h3>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ†</h3></div>`;
  if(mSnap.empty){
    html += `<div class="card">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø¯ÙˆØ¨ÙˆÙ†</div>`;
  } else {
    mSnap.forEach(d=>{
      const m = d.data();
      if(isExec){
        html += `<div class="order-card" style="background:#fff;color:#111;border:1px solid var(--border);">
          <p><b>ğŸï¸ ${m.name}</b> ${m.status==='inactive' ? '(Ù…ÙˆÙ‚ÙˆÙ)':''}</p>
          <p>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: <b>${m.phone||'-'}</b></p>
          <p>ğŸ”‘ ÙŠÙˆØ²Ø±: <b>${m.user||'-'}</b> â€¢ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <b>${m.password||'-'}</b></p>
          <div style="margin-top:8px">
            <button class="btnx btnx-red" data-act="del" data-type="mandoubs" data-id="${d.id}">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            ${m.status==='inactive'
              ? `<button class="btnx btnx-green" data-act="activate" data-type="mandoubs" data-id="${d.id}">ğŸŸ¢ ØªÙØ¹ÙŠÙ„</button>`
              : `<button class="btnx btnx-yellow" data-act="deactivate" data-type="mandoubs" data-id="${d.id}">ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>`}
            <button class="btnx btnx-gray" data-act="resetpw" data-type="mandoubs" data-id="${d.id}">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
          </div>
        </div>`;
      } else if(isTech || isFollow){
        html += `<div class="order-card" style="background:#fff;color:#111;border:1px solid var(--border);">
          <p><b>ğŸï¸ ${m.name}</b></p>
        </div>`;
      }
    });
  }

  // Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  content.innerHTML = html;

  // Ø§Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø­Ø°Ù/Ø§ÙŠÙ‚Ø§Ù/ØªÙØ¹ÙŠÙ„/Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†)
  content.querySelectorAll('[data-act]').forEach(btn=>{
    btn.onclick = async ()=>{
      const act  = btn.dataset.act;       // del / deactivate / activate / resetpw
      const type = btn.dataset.type;      // "users" Ø£Ùˆ "mandoubs"
      const id   = btn.dataset.id;

      const ses = getSession();
      const isExecNow = (ses?.role === 'Ù…Ø¯ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ' || /ØªÙ†ÙÙŠØ°ÙŠ/i.test(ses?.role||''));
      if(!isExecNow){ return Swal.fire('Ù…Ù…Ù†ÙˆØ¹','Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©','error'); }

      if(act==='del'){
        const r = await Swal.fire({title:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ',text:'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…',icon:'warning',showCancelButton:true,confirmButtonText:'Ø­Ø°Ù'});
        if(!r.isConfirmed) return;
        await deleteDoc(doc(db, type, id));
        Swal.fire('ØªÙ…','Ø­ÙØ°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§','success');
        return renderPeople();
      }

      if(act==='deactivate'){
        await updateDoc(doc(db, type, id), { status:'inactive' });
        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await addDoc(collection(db,'notifications'),{
          to: id, roleTarget: (type==='mandoubs'?'mandoub':'user'),
          title:'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª', message:'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©.',
          at: serverTimestamp(), seen:false
        });
        Swal.fire('ØªÙ…','ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªÙ‹Ø§','success');
        return renderPeople();
      }

      if(act==='activate'){
        await updateDoc(doc(db, type, id), { status:'active' });
        await addDoc(collection(db,'notifications'),{
          to: id, roleTarget: (type==='mandoubs'?'mandoub':'user'),
          title:'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨', message:'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.',
          at: serverTimestamp(), seen:false
        });
        Swal.fire('ØªÙ…','ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨','success');
        return renderPeople();
      }

      if(act==='resetpw'){
        const { value: newpw } = await Swal.fire({
          title: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
          input: 'text',
          inputLabel: 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø³ÙŠÙØ·Ù„Ø¨ Ù…Ù†Ù‡ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§)',
          inputPlaceholder: 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©',
          showCancelButton:true
        });
        if(!newpw) return;
        await updateDoc(doc(db,type,id), { password: newpw, mustChangePassword: true });
        await addDoc(collection(db,'notifications'),{
          to: id, roleTarget: (type==='mandoubs'?'mandoub':'user'),
          title:'ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©', message:'ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© Ù„Ø­Ø³Ø§Ø¨Ùƒ. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.',
          at: serverTimestamp(), seen:false
        });
        Swal.fire('ØªÙ…','ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©','success');
        return renderPeople();
      }
    };
  });
}

/* ========== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ========== */
let unsubNotifs=null;
function renderNotifications(){
  content.innerHTML = `<div class="card"><h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3><div id="notifList"></div></div>`;
  if(unsubNotifs) unsubNotifs();
  unsubNotifs = onSnapshot(query(collection(db,'notifications'), orderBy('at','desc')), (snap)=>{
    let html='';
    snap.docChanges().forEach(ch=>{ if(ch.type==='added'){ try{beep.currentTime=0; beep.play();}catch{} }});
    snap.forEach(d=>{
      const n=d.data(); const dd=n.at?.toDate ? n.at.toDate() : null;
      const when = dd? `${dd.getDate()}/${dd.getMonth()+1}/${dd.getFullYear()} â€¢ ${apm(dd)}` : '-';
      html += `<div class="card" style="border-color:#ffd8b6">
        <b>ğŸ”” ${n.title||'ØªÙ†Ø¨ÙŠÙ‡'}</b><br>${n.message||''}<br>
        <small>${n.by||'-'} â€¢ ${when}</small>
      </div>`;
    });
    $('#notifList').innerHTML = html || 'Ù„Ø§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
  });
}

/* ========== Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ========== */
window.setDelivered = async (id)=>{
  const ses=getSession();
  await updateDoc(doc(db,'orders',id), {status:'delivered', deliveredAt:serverTimestamp(), lastUpdate:serverTimestamp()});
  await addDoc(collection(db,'notifications'),{type:'order_update',title:'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙˆØ§ØµÙ„',message:`Ø·Ù„Ø¨ #${id} Ø£ØµØ¨Ø­ ÙˆØ§ØµÙ„`,orderId:id,roleTarget:'mandoub+manager',by:(ses?.name||ses?.user||'Ù…Ø¯ÙŠØ±'),at:serverTimestamp(),seen:false});
  Swal.fire('ØªÙ…','Ù†ÙÙ‚Ù„Øª Ø¥Ù„Ù‰ ÙˆØ§ØµÙ„','success');
};
window.delayDirect = async (id)=>{
  await updateDoc(doc(db,'orders',id), {status:'delayed', lastUpdate:serverTimestamp()});
  Swal.fire('ØªÙ…','Ø£ÙØ¶ÙŠÙ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø¬Ù„ (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¨Ø§Ø¨)','success');
};
window.askReject = async (id)=>{
  const {value:reason} = await Swal.fire({
    title:'Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶', input:'select',
    inputOptions:{'Ù„Ø§ ÙŠØ±Ø¯':'Ù„Ø§ ÙŠØ±Ø¯','Ù„Ø§ÙŠØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚':'Ù„Ø§ÙŠØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚','Ù…ØºÙ„Ù‚':'Ù…ØºÙ„Ù‚','Ù…ØºÙ„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚':'Ù…ØºÙ„Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚',
      'Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø·Ù„Ø¨':'Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø·Ù„Ø¨','Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù‚ÙŠØ§Ø³':'Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù‚ÙŠØ§Ø³','Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù„ÙˆÙ†':'Ø±ÙØ¶ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ù„ÙˆÙ†',
      'Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨':'Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨','ØªØºÙŠØ± Ø³Ø¹Ø±':'ØªØºÙŠØ± Ø³Ø¹Ø±'},
    inputPlaceholder:'Ø§Ø®ØªØ± Ø³Ø¨Ø¨', showCancelButton:true
  });
  if(!reason) return;
  let updates = {status:'temp', tempType:'reject', reason, lastUpdate:serverTimestamp()};
  if(reason==='ØªØºÙŠØ± Ø³Ø¹Ø±'){
    const {value:newPrice} = await Swal.fire({title:'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯', input:'number', inputAttributes:{min:0}, showCancelButton:true});
    if(!newPrice) return;
    const {isConfirmed:hasReturn} = await Swal.fire({title:'Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¬Ø¹ØŸ', icon:'question', showCancelButton:true, confirmButtonText:'Ù†Ø¹Ù…', cancelButtonText:'Ù„Ø§'});
    updates.newAmount=Number(newPrice); updates.managerNote = (hasReturn? 'ØªØºÙŠÙŠØ± Ø³Ø¹Ø± + ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¬Ø¹' : 'ØªØºÙŠÙŠØ± Ø³Ø¹Ø±');
  }
  const {value:note} = await Swal.fire({title:'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', input:'text', showCancelButton:true});
  if(note) updates.managerNote = (updates.managerNote? updates.managerNote+' â€” ' : '') + note;
  await updateDoc(doc(db,'orders',id), updates);
  Swal.fire('ØªÙ…','Ø£ÙØ±Ø³Ù„ Ù„Ù…Ø¤Ù‚Øª Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±','success');
};
window.backToPending = async (id)=>{
  await updateDoc(doc(db,'orders',id), {status:'pending', lastUpdate:serverTimestamp()});
  Swal.fire('ØªÙ…','Ø£ÙØ¹ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','success');
};
window.askNote = async (id)=>{
  const {value:note} = await Swal.fire({title:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', input:'text', showCancelButton:true});
  if(note){ await updateDoc(doc(db,'orders',id), {managerNote: note, lastUpdate:serverTimestamp()}); Swal.fire('ØªÙ…','Ø­ÙÙØ¸Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©','success'); }
};
window.askDelete = async (id)=>{
  const r=await Swal.fire({title:'Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ', icon:'warning', showCancelButton:true, confirmButtonText:'Ø­Ø°Ù'});
  if(r.isConfirmed){ await deleteDoc(doc(db,'orders',id)); Swal.fire('ØªÙ…','Ø­ÙØ°Ù Ø§Ù„Ø·Ù„Ø¨','success'); }
};
window.approveTemp = async (id)=>{
  const d = await getDoc(doc(db,'orders',id)); if(!d.exists()) return;
  const o=d.data();
  if(o.tempType==='reject'){ await updateDoc(doc(db,'orders',id), {status:'rejected', lastUpdate:serverTimestamp()}); }
  if(o.tempType==='delayed'){ await updateDoc(doc(db,'orders',id), {status:'delayed', lastUpdate:serverTimestamp()}); }
  Swal.fire('ØªÙ…','ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø§Ø±','success');
};

/* Ø§Ø¨Ø¯Ø£ */
requireLogin();
</script>
</body>
</html>
